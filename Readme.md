# 用于解析 pyc 文件

一. pyc 文件结构
    a. 以 hello.py (print 1 + 2 * 3) 为例：
        1. 一个整数 0xa0df303，代表文件类型和版本（该例子中版本为 python2.7），记为魔数（magic number）。【四个字节】
        2. 一个整数，代表文件创建时间。【四个字节】
        3. 一个固定字符 c（0x63），说明接下来是一个CodeObject结构。【一个字节】
        4. CodeObejct
            4.1 一个整数 0（0x0），代表参数个数，记为 argcount。【四个字节】
            4.2 一个整数 0（0x0），代表局部变量个数，记为 nlocals。【四个字节】
            4.3 一个整数 3（0x3），代表执行这段 code 所使用的操作数栈的最大深度，记为 stacksize。【四个字节】
            4.4 一个整数 64（0x40），代表 code 的属性值，记为 flags。【四个字节】
            4.5 一个固定字符 s（0x73），说明接下来是和字节码相关的内容。【一个字节】
            4.6 一个整数 13（0xd），代表这段 code 的字节码长度。【四个字节】
            4.7 一段字节码。【十三个字节】
            4.8 一个元组，代表常量表，记为 counts。【二十六个字节】
                4.8.1 一个字符 (（0x28），说明接下来是一个元组。【一个字节】                
                4.8.2 一个整数，代表元组中的元素个数。【四个字节】
                4.8.3 一个字符 i（0x69），说明接下来的元素是一个整数。【一个字节】
                4.8.4 一个整数 1（0x1），代表 print 1 + 2 * 3 中的 1。【四个字节】
                4.8.5 一个字符 i（0x69），说明接下来的元素是一个整数。【一个字节】
                4.8.6 一个整数 2（0x2），代表 print 1 + 2 * 3 中的 2。【四个字节】
                4.8.7 一个字符 i（0x69），说明接下来的元素是一个整数。【一个字节】
                4.8.8一个整数 3（0x3），代表 print 1 + 2 * 3 中的 3。【四个字节】
                4.8.9 一个字符 N（0x4e），代表 python 中的 None。【一个字节】
                4.8.10 一个字符 i（0x69），说明接下来的元素是一个整数。【一个字节】
                4.8.11 一个整数 6（0x6），代表 print 1 + 2 * 3 中 2 * 3 的结果。【四个字节】
            4.9 一个元组，代表变量表，记为 names。【五个字节】
                4.9.1 一个字符 (（0x28），说明接下来是一个元组。【一个字节】
                4.9.2 一个整数 0（0x0），代表变量表为空。【四个字节】
            4.10 一个元组，代表参数列表。【五个字节】
                4.10.1 一个字符 (（0x28），说明接下来是一个元组。【一个字节】
                4.10.2 一个整数 0（0x0），代表参数列表为空，原因是这一项只在函数和方法里有用，表示函数的输入参数，而hello.py 中没有函数。【四个字节】
            4.11 一个元组，用于构建闭包，记为 cell_var。【五个字节】
                4.11.1 一个字符 (（0x28），说明接下来是一个元组。【一个字节】
                4.11.2 一个整数 0（0x0）【四个字节】
            4.12 一个元组，用于构建闭包，记为 free_var。【五个字节】
                4.12.1 一个字符 (（0x28），说明接下来是一个元组。【一个字节】
                4.12.2 一个整数 0（0x0）【四个字节】
            4.13 一个字符 s（0x73），说明接下来是一个字符串。【一个字节】
            4.14 一个整数 8（0x8），代表字符串的长度，即 hello.py 的长度。【四个字节】
            4.15 一个字符串 hello.py（0x68 65 6c 6c 6f 2e 70 79），代表当前执行的 code 的脚本名称。【八个字节】
            4.16 一个字符 t（0x74），说明接下来是一个字符串。【一个字节】
            4.17 一个整数 8（0x8），代表字符串的长度。【四个字节】
            4.18 一个字符串 <module>（0x6d 6f 64 75 6c 65 3e），代表当前 code 所属的模块。【八个字节】
            4.19 一个整数 1（0x1），code 在 hello.py 中的起始行【四个字节】
            4.20 一个字符 s（0x73），说明接下来是一个字符串，这是一个名为 line number table 的结构，在实现 Traceback 时，要输出详细的调用栈，会用到这个数据结构。【一个字节】
            4.21 一个整数 0（0x0），代表字符串的长度。【四个字节】
    b. CodeObject 结构
        /*
        typedef struct {
            PyObject_HEAD
            int co_argcount;        /* 位置参数个数 */
            int co_nlocals;         /* 局部变量个数 */
            int co_stacksize;       /* 栈大小 */
            int co_flags;   
            PyObject *co_code;      /* 字节码指令序列 */
            PyObject *co_consts;    /* 所有常量集合 */
            PyObject *co_names;     /* 所有符号名称集合 */
            PyObject *co_freevars;  /* 闭包用的的变量名集合 */
            PyObject *co_cellvars;  /* 内部嵌套函数引用的变量名集合 */
            /* The rest doesn’t count for hash/cmp */
            PyObject *co_filename;  /* 代码所在文件名 */
            PyObject *co_name;      /* 模块名|函数名|类名 */
            int co_firstlineno;     /* 代码块在文件中的起始行号 */
            PyObject *co_lnotab;    /* 字节码指令和行号的对应关系 */
            void *co_zombieframe;   /* for optimization only (see frameobject.c) */
        } PyCodeObject;
        */

二、加载 CodeObject
    1. 封装一个读 pyc 文件的类，具有三个属性，提供四个功能：
        属性：
            a. fp：pyc 的文件指针；
            b. szBuffer：存储 pyc 的文件内容；
            c. index：指向当前读到了 szBuffer 中的哪个位置。
        功能：
            a. 构造函数：将 pyc 文件中的内容读到一个 buffer 里；
            b. read：读一个字符，并返回；
            c. read_int：读一个整数，并返回；
            d. unread：buffer 指针减一。
    2. 实现一个列表来表达 pyc 文件中的元组结构，具有两个特性，三个属性，提供八个功能：
        特性：
            a. 为了节约内存，希望这个列表是可以动态扩展的。这样的话，可以在一开始让列表的容量小一些，当元素越来越多时，再重新分配内存；
            b. 列表作为容器，希望它能容纳各种类型的元素，因此，这里使用模板来实现列表。
        属性：
            a. _length：元素数组的大小；
            b. _array：指向元素数组的指针；
            c. _size：当前列表里有多少个有效元素。
        功能：
            public：
                a. add：向列表末尾插入元素；
                b. insert：向列表的指定位置插入元素；
                c. get：获取列表指定位置的元素；
                d. set：设置列表指定位置的元素；
                e. size：获取列表有效元素的个数；
                f. length：获取元素数组的大小；
                h. pop：弹出列表的末尾元素。
            private：
                a. expand：当有效元素数量超过元素数组的容量时，扩展元素数组。
    3. 在 Python中所有的数据都是对象，包括字符串、整数、浮点数、类定义、模块、函数等，而他们都有共同的基类 object，因此需要创建一个基类。
    4. 创建一个字符串类，来表示 Python 中的字符串，具有两个属性，提供两个方法：
        属性：
            a. _value：字符串的值；
            b. _length：字符串的长度。
        方法：
            a. value：获取字符串的值；            
            b. length：获取字符串的长度。
    5. 创建一个整数类，来表示 Python 中的整数，具有一个属性，提供一个方法：
        属性：
            a. _value：整数的值。
        方法：
            a. value：获取整数的值。
    6. 创建 CodeObject 类
        属性：
            a. _argcount：参数个数；
            b. _nlocals：局部变量个数；
            c. _stack_size：执行这段 code 所用的栈的最大深度；
            d. _flag：code 的属性值；

            e. _bytecodes：字节码指令序列
            f. _names：所有符号名称集合；
            g. _consts：所有常量集合；
            h. _var_names：局部变量名称集合；

            i. _free_vars：闭包用的变量名集合；
            j. _cell_vars：内部嵌套函数引用的变量名集合；
            
            k. _co_name：code 所在模块名
            l. _file_name：code 所在文件名
            
            m. _lineno：字节码指令和行号的对应关系
            n. _notable：